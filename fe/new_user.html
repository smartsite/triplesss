<html>
    <head>
        <title>New user</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://fonts.googleapis.com/css2?family=Raleway" rel="stylesheet">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link href="css/vivify.min.css" rel="stylesheet" type="text/css">
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>      
        <link href="/css/main.css" rel="stylesheet" type="text/css">
        <style>
            .wrap {
                height:100%;
            }

            .act {
                position: relative;
                margin-left: 160px;
                width: 170px;
                margin-top: -35px;
            }

            #available {
                margin-left: 140px;              
                position: relative;
                top: -57px;
            }
        </style>
    </head>
    <body>
        <div class="toprow">                  
            <div class="clear"></div>            
        </div>    
       
        <div class="wrap">
            <div id="namecheck" class="add">
                <h3>Enter a user name</h3>
                <p>( no spaces, characters, or underscores, <b>at least</b> 5 characters )</p>
                <p><b>Examples</b></p>
                <span class="greenTick"> &#10004;</span> richie <br />                  
                <span class="greenTick"> &#10004;</span> Fred99 <br />   
                <span class="greenTick"> &#10004;</span> RegGrundy <br />    
                <span class="redCross"> &#10006;</span> me  <br />    
                <span class="redCross"> &#10006;</span> Jeff St.John  <br />
                <span class="redCross"> &#10006;</span> julialouise-dreyfuss<br /> 
                <span class="redCross"> &#10006;</span> 101101001<br />  
                <span class="redCross"> &#10006;</span> =kit^^ty=<br />  
                <br />  

                <form id="add-user" method="POST">    
                   <input type="text" id="username" name="username" value="">
                   <input type="hidden" id="userid" name="userid" value="1">
                    <br />
                    <br />
                   <button id="post-user">Check availability</button><div class="act">  &#9664; type a valid<br />&nbsp;&nbsp;&nbsp; username to &nbsp;&nbsp;&nbsp;&nbsp;activate</div>
                   <span id="available"></span>
                </form>
            </div>

            <div id="details" class="details hidden">
                <h3>Add details</h3>
                <p>( none of these details can be seen by other users - only your username is visible )</p>
                <form id="add-detail" method="POST">                  
                   
                    <input type="text" id="firstname" name="firstname" value="" placeholder="First name"><br />
                  
                    <input type="text" id="lastname" name="lastname" value="" placeholder="Last name"><br />
                  
                    <input type="email" id="email" name="email" value="" placeholder="email"><br />                                                       
                  
                    <p>( min length 8 characters, at least one uppercase letter, a character, and a number e.g. bLUe234! )</p>
                    <input type="password" id="password1" name="password1" value="" placeholder="password"><br />
                    <br />
                    
                    <input type="password" id="password2" name="password2" value="" placeholder="password (again)"><br />                 
                    <br />
                   <button id="register-user">Register</button>
                   <span id="available"></span>
                </form>
            </div>
            <div id="confirm" class="details hidden">
                <h3>Confirm your registration</h3>
                <p>Thanks for registering!</p>
                <p>An email has been sent to <span id="confirm-email"></span>, 
                    and it should arrive within the next 5 minutes. Just tap or click on the link in the email 
                    to confirm your registration.</p>
                <p>Didn't get the email? Try the following:</p>
                <ul>
                    <li>Check your spam / junk mail folder</li>
                    <li>Make sure you have waited 5 minutes!</li>
                    <li>Make sure you are checking the email address shown above</li>
                    <li>Try and <a id="resend" href="">re-send</a> the registration email</li>                     
                </ul>     
                <p>If you still have no luck, <a href="mailto:registerhelp@surfsouthoz.com">contact us</a> and we'll help!</p>
            </div>    
           
            <div id="lbox" class="lightbox"></div>           
        </div>       

        <script language="Javascript">

            let lightbox;

            const setCookie = (name, value, exdays) => {
                var exdate = new Date();
                exdate.setDate(exdate.getDate() + exdays);
                var c_value = escape(value) + ((exdays == null) ? "" : "; expires=" + exdate.toUTCString());
                document.cookie = name + "=" + c_value;
            }

            const getCookie = (name) => {
                var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
                if (match) return match[2];
            }

            const resendLink = () => {              
                
                const user_id = getCookie('userID');
                const confirmSpan = document.getElementById('confirm-email');
                const from = "admin@surfsouthoz.com.au";
                const reply = "register@surfsouthoz.com.au";

                fetch('Triplesss/api/register_link?user_id=' + user_id + '&from_email=' + from + '&reply_email=' + reply, {
                            method: "GET"
                                                
                    }
                ).then(function(response) {                  
                    response.json().then(function(d){
                        console.log(d);
                        if(d.hasOwnProperty('email')) {
                           
                            if(d.email != '') {
                                confirmSpan.innerText = d.email;
                                showBox(true, 'confirm');
                                showBox(false, 'fail');
                            } else {
                                // something went wrong :(    
                            }
                        } else {
                            // something went wrong :(    
                        }                                                       
                    })                  
                });
            } 

            const showBox = (show, id) => {
                if(show == true) {
                    document.getElementById(id).classList.remove('hidden');
                    document.getElementById(id).classList.add('fadeIn');
                    window.setTimeout(function() {
                        document.getElementById(id).classList.remove('fadeIn');
                    }, 1000)
                } else {
                    document.getElementById(id).classList.add('hidden');
                    document.getElementById(id).classList.remove('fadeIn');
                }
            }            

            const fieldError = (t, status) => {
                t.classList.add('field_error'); 
                if(status == true) {
                    t.classList.remove('field_error');                     
                } 
                return status;
            }
            
            const usernameStatus = (avail) => {
                var availableBox = document.getElementById("available");
               
                if(avail == true) {
                    availableBox.innerHTML = "&#10006;";                  
                    availableBox.style = "color: transparent; text-shadow:0 0 0 rgb(220,20,20)";
                    showBox(false, 'details');
                   
                } else {
                    availableBox.innerHTML = "&#10004;";                  
                    availableBox.style = "color: transparent; text-shadow:0 0 0 rgb(20,200,20)";
                    showBox(true, 'details');
                }
            }         

            const checkUser = (username) => {              
              let data = {};
              data.username = username;
              fetch('Triplesss/api/checkuser', {
                        method: "POST",
                        body: JSON.stringify(data)                           
                  }
              ).then(function(response) {                  
                  response.json().then(function(d){
                        usernameStatus(d);                                    
                  })
              });             
            }            

            const checkNameFieldLength = (t, length) => {
                return t.value.length > length;	
            }          
     
            const checkNames = (t) => {                
                return fieldError(t, t.value.length > 2 && isAlpha(t.value));                
            }

            const checkPostcode = (t) => {               
                return fieldError(t, t.value.length == 4);                
            }

            const checkPassword = (t) => {
                const mediumRegex = new RegExp("^(((?=.*[a-z])(?=.*[A-Z]))|((?=.*[a-z])(?=.*[0-9]))|((?=.*[A-Z])(?=.*[0-9])))(?=.{6,})");
                const strongRegex = new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\$%\^&\*])(?=.{8,})");
                return fieldError(t, strongRegex.test(t.value));
            }

            const checkEmail = (t) => {
                const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                return fieldError(t, re.test(t.value));
            }

            const checkAddress = (t) => {                
                return fieldError(t, checkNameFieldLength(t,3));
            }

            const checkPhone = (t) => {                
                return fieldError(t,  !isNaN(t.value) && t.value.length === 10 );
            }          
            
            const addUser = () => {
              
                let conf = document.getElementById("confirm-email");
                let user_id = document.getElementById("userid");
                let data = {};

                data.user_name = document.getElementById('username').value;
                data.first_name = document.getElementById('firstname').value;
                data.last_name = document.getElementById('lastname').value;
                data.email = document.getElementById('email').value;
                data.password = document.getElementById('password1').value;
                data.hash = true;
                data.from_email = 'webmaster@surfsouthoz.com';
                data.reply_email = 'register@surfsouthoz.com';
                conf.innerText =  data.email;


                fetch('Triplesss/api/register', {
                            method: "POST",
                            body: JSON.stringify(data)                           
                    }
                ).then(function(response) {
                    
                    response.json().then(function(d){
                        console.log(d);
                        if(d.hasOwnProperty('userid')) {
                            var userid = d.userid * 1;
                            if(userid > 0) {
                                user_id.value = userid;
                                setCookie('userID', userid, 1); // we can use this to re-send verification if we need to!
                                showBox(false, 'details');
                                showBox(false, 'namecheck');
                                showBox(true, 'confirm');
                            } else {
                                // something went wrong :(    
                            }
                        } else {
                            // something went wrong :(    
                        }                                                       
                    })                   
                    
                });
            } 

            const lowlightelements = (s, el) => {                      
                el.forEach(function(el) { 
                    if(s === true) {
                        el.classList.add('lowlight');
                    } else {
                        el.classList.remove('lowlight');
                    }    
                });   
            }

            
            const lightboxshow = (s) => {
                if(s === true) {
                    lightbox.classList.add('active');                   
                } else {
                    lightbox.classList.remove('active');
                }
                lowlightelements(s, document.querySelectorAll('.post'));
            } 

            const isAlpha = (text) => {
                if(text.match(/^[0-9a-zA-Z]+$/)) {
                    return true;
                } else {                   
                    return false;
                } 
            }
            
            const validusername = (text) => {
                if(text.length > 4 && text.length < 33 && isAlpha(text) && text.indexOf('surfsouth') == -1 && text.indexOf('fuck') == -1 && text.indexOf('cunt') == -1) {
                    return true;
                } else {
                    return false;
                }
            }

            const checkFields = () => {
                var textFields = document.querySelectorAll("#details input");
                var allgood = 0;
             
                for(var el of Object.entries(textFields)) {
                    let val = el[1].value;
                    let id = el[1].id;
                    const password1 = document.getElementById('password1').value;
                    const password2 = document.getElementById('password2').value;
                    let f = el[1];                    

                    switch (id) {
                      
                        case "password1":
                            allgood+= 1& checkPassword(f);
                        break;

                        case "password2":
                            allgood+= 1 & checkPassword(f);
                            allgood+= 1 & fieldError(f, password1 == password2 && password2 != '');  
                        break;
                        
                        case "email":
                            allgood+= 1 & checkEmail(f);
                        break;
                        
                        case "firstname":
                            allgood+= 1 & checkNames(f);				
                        break;
                        
                        case "lastname":
                            allgood+= 1 & checkNames(f);				
                        break;                                                    
                        
                    }                    
                }
                
                if(allgood == 6) {
                    addUser();
                }
            }       
                 
          
            
            window.onload = () => {                
           
                const postButton = document.getElementById("post-user");
                const registerButton = document.getElementById("register-user");
                const username = document.getElementById("username");
                const resendButton = document.getElementById("resend");
                const tickcross = document.getElementById("available");

                postButton.setAttribute('disabled', true);                       
               
                username.addEventListener('keyup', function(e) {
                    let text = e.target.value;
                    tickcross.innerHTML = '';

                    if(validusername(text)) {                       
                        postButton.removeAttribute('disabled');
                    } else {                  
                        postButton.setAttribute('disabled', false);
                    }                  
                })
              
                postButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    checkUser(username.value);                   
                })

                registerButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    checkFields();                    
                })

                resendButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    resendLink();                   
                })

            }  

           

        </script>
    </body>
</html>




