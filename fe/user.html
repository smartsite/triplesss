<html>
    <head>
        <title>User post test</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https//fonts.googleapis.com/css2?family=Raleway&display=swap rel="stylesheet">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link href="css/vivify.min.css" rel="stylesheet" type="text/css">
        <link href="css/user.css" rel="stylesheet" type="text/css">
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>       
        <style>
            .wrap.loggedout {
                height:100%;
            }


            .reactions {
                margin-right:5px;
                margin-top:-35px;
            }

            .post button i {
                color:#000;
            }

        </style>
    </head>
    <body>
        <!-- <h2>User feed test</h2> -->
        <div class="toprow">
            <div id="head-wave"><img src="img/head_wave.svg" /></div>
            <h3>               
                <span id="avatar">
                    <img src="img/profile.png" />
                </span>
                <span id="uname"></span></h3>
            <button id="log-out">log out</button>
            <div class="clear"></div>
        </div>    
        </select>
        <div class="wrap">
            <div id="profile" class="add lowlight">
                <div class="avatar">
                    <img src="../img/profile.png" />
                </div>
                <h3></h3>
                <div class="bio"></div>
            </div>  
            <div id="addpost" class="add">
                <label>Select a channel</label>
                <select id="feed_id"></select>
                <p>Post something</p>
                <form id="add-post" method="POST">
                   <textarea id="add-comment" rows="3" cols="36"></textarea><br /><br />
                   <input type="hidden" id="userid" name="userid" value="2">
                   <input type="hidden" id="feedid" name="feedid" value="<?php //echo $feed->getId();  ?>">
                   <input id="image" name="image" type="file" accept="image/x-png,image/gif,image/jpeg" />
                   <button id="post-comment">Post</button>
                </form>
            </div>
            <div id="keycheck" class="add">
                <h3>Login</h3>
                <form id="add-user" method="POST">                  
                    <label>user name</label>
                    <input type="text" id="username" name="username" value="">
                    <label>password</label>
                    <input type="password" id="password" name="password" value="">
                    <br />
                    <br />
                   <button id="log-in">Log in</button>                  
                </form>
            </div> 
            <div id="fail" class="add">
                <h3>Login failed</h3>  
                <p>Please check you have the correct details! </p>               
            </div>
            <div id="editbox" class="vivify postbox lowlight">
                <p>Edit post</p>
                <textarea id="edit-comment" rows="3" cols="36"></textarea><br /><br />               
                <button id="savepost">Save</button>
                <button class="cancel">Cancel</button>
            </div>  
            <div id="tagbox" class="vivify postbox lowlight">
                <p>Add or edit tags</p>
                <input type="text" /><br /><br />      
                <button id="tagpost">Save</button>
                <button class="cancel">Cancel</button>
            </div>
            <div id="deletebox" class="vivify postbox lowlight">
                <p>Delete this post?</p>
                <button id="delete-yes">Yes, delete it</button>&nbsp;  <button class="cancel">No! keep it</button> 
            </div>  
            <div id="commentbox" class="vivify postbox lowlight">
                <p>Add a comment</p>
                <textarea id="post-comment-text" rows="5" cols="36"></textarea><br />  
                <button id="comment-post">Post</button>
                <button class="cancel">&#10005;</button>
                <div id="comments"></div>
            </div> 
            <div id="privacybox" class="vivify postbox lowlight">
                <p>Adjust who can see this post</p>
                <select id="visibility">
                    <option value=0>Me</options>
                    <option value=1>Group</options>
                    <option value=2>Friends</options>
                    <option value=3>Friends of friends</options>
                    <option value=4>Anyone</options>
                </select>
                <button id="privacypost">Save</button>
                <button class="cancel">Cancel</button>
            </div>    
            <div id="feed" class="feed">
            </div>
            <div id="lbox" class="lightbox"></div>           
        </div>

        <script language="Javascript">

            var lightbox;
            let toppos = 0;    
        </script>  
        
        <script src="js/user.js"></script>

        <script language="Javascript">
        

            let postMarkup = (post, container) => {               
                
                post.map(function(p) {
                   
                    if(p[0]) {
                        const postId = p[0].post_id;
                        let postWrap = newDiv('post');
                        let contentWrap = newDiv('content-wrap');
                        postWrap.id = postId;
                        //postWrap.setAttribute('data-post_id', postId);
                        
                        let contentWrapImage = newDiv('postcontent image');
                        let contentWrapText = newDiv('postcontent text');
                        
                        //postWrap.appendChild(postMenu());                    
                        postWrap.appendChild(postMenu2());  
                        postWrap.appendChild(reactions(p));    

                        p.map(function(po) {                      
                            if(po.content_type == "text") {
                                contentWrapText.innerText = po.content;
                                contentWrap.appendChild(contentWrapText);
                            }
                            if(po.content_type == "image") {
                                const img =  document.createElement('img');
                                img.src = po.path + "/" + po.link;
                                contentWrapImage.appendChild(img);
                                contentWrap.appendChild(contentWrapImage);
                            }
                        })

                       
                        postWrap.appendChild(contentWrap);                          
                        container.appendChild(postWrap);
                    }                   
                });              
            }

            let clearPostBox = () => {                
                document.getElementById('add-comment').value = '';
                document.getElementById('image').value = '';
            }

            let setSelect = (selectObj, index) => {
                Array.from(selectObj.options).forEach((op, i)=>{
                    console.log(i);
                });               
            }


            let feed = (feed_id) => {
                let container = document.querySelectorAll('.feed')[0];
                container.innerHTML = '';
                return fetch('Triplesss/api/feed.php?feed_id=' + feed_id, {
                            method: "GET"                                                    
                }) 
                .then(function(response) {
                    response.json().then(function(d){
                        postMarkup(d, container);  
                        menuHandler();                     
                    });
                });       
            }

            let feedlist = () => {
                const userid = getCookie('userID');
                const saved_feedid = getCookie('feed_id');
                const feedSelect = document.getElementById('feed_id');
                fetch('Triplesss/api/feeds.php?userid=' + userid, {
                    method: "GET"                                                    
                }) 
                .then(function(response) {
                    response.json().then(function(d){
                        const feed_id = d[0].id;
                        if(saved_feedid) {
                            feed(saved_feedid);
                        } else {
                            feed(feed_id);
                        }
                       
                        if(d.length > 0) {
                            d.map(function(r){
                                const option = document.createElement('option');
                                option.text = r.feed_name;
                                option.value = r.id;
                                feedSelect.add(option);
                                if(saved_feedid == r.id) {
                                    option.selected = true; 
                                }
                            })
                        } else {
                            // Every user has at least ONE feed so this should neve rhappen
                        }
                    })
                })
            }

            let sendReport = (e) => {
               
                var groupId = e.parentElement.className.replace("reportbox vivify ", "");
                //console.log(groupId);

                e.parentElement.classList.add('fadeOut');
                window.setTimeout(function(){
                    e.parentElement.classList.add('lowlight');
                    lightboxshow(false);
                    var wrapper = document.getElementsByClassName('post ' + groupId)[0];
                    menushow(wrapper, false);   
                    //menushow(wrapper, false); 
                }, 500)
            }

            let doPost = (data) => {
                return fetch('Triplesss/api/post.php', {
                            method: "POST",
                            body: JSON.stringify(data)                           
                }) 
                .then(function(response) {
                    response.json().then(function(d){
                        var postId = d.postId; 
                        clearPostBox();  
                        console.log(postId);
                    })
                })
            }

                        
            let addPost = () => {
                var img = document.getElementById('image').files[0];
                var user_id = document.getElementById('userid').value;
                var feed_id = document.getElementById('feed_id').value;
                var comment = document.getElementById('add-comment').value;
            
                // Check if there's an image
                var reader = new FileReader();

                reader.onload = (function(t) {
                    return function(e) {
                        var im = e.target.result;
                        var data = {'comment': comment, 'image' : im, 'userid': user_id, 'feedid': feed_id, 'basefolder' : '../../storage' };
                        doPost(data).then(function(){
                            feed(feed_id);
                        });                  
                    }
                })(img); 
            
                //reader.readAsDataURL(img);
                if(typeof img === 'object') {
                    reader.readAsDataURL(img);
                } else { 
                    // we don't have an image... just text
                    var image = '';
                    var data = {'comment': comment, 'image' : image, 'userid': user_id, 'feedid': feed_id, 'basefolder' : '../../storage' };
                    doPost(data).then(function(){
                        feed(feed_id);
                    });    
                }
            } 

            let getTags = (el) => { 
                const data = {};
                const post_id =  el.parentElement.id;    
                const user_id = getCookie('userID');                                        
                data.post_id = post_id; 
                data.user_id = user_id;

                return fetch('Triplesss/api/post_tags.php?user_id=' + user_id + '&post_id=' + post_id, {
                    method: "GET"                                                 
                }) 
                .then(function(response) {                   
                    
                    response.json().then(function(d){
                       // show tags in the textbox   
                       let tags = "";
                       if(d.tags) {
                            if(d.tags.length > 0) {
                                const tag_array = d.tags.split(',');
                                tags = tag_array.map((tag)=>{
                                    return "#" + tag;
                                }).join(' ');
                            }                            
                        }                       
                       document.querySelectorAll('#tagbox input')[0].value = tags;                    
                    })                    
                })
            }


            let editTags = (el) => {
                const data = {};
                const post_id =  el.parentElement.getAttribute('data-post_id');    
                const user_id = getCookie('userID');  
                const tags = document.querySelectorAll('#tagbox input')[0].value;               
                data.post_id = post_id; 
                data.user_id = user_id;
                data.tags = tags;

                return fetch('Triplesss/api/post_tags.php', {
                            method: "POST",
                            body: JSON.stringify(data)                           
                }) 
                .then(function(response) {
                    response.json().then(function(d){
                       
                       if(d == true) {
                            
                       } else {
                           // show error modal
                       }

                       document.getElementById('tagbox').classList.add('lowlight');
                       lightboxshow(false);  
                       setScrollPos();
                       hideAllMenus();
                    })
                })
            }


            let setPostVisibility = (level, el, user_id) => {
                const data = {};
                const post_id =  el.parentElement.getAttribute('data-post_id');
                data.level = level;                              
                data.post_id = post_id; 
                data.user_id = user_id;

                return fetch('Triplesss/api/post_visibility.php', {
                            method: "POST",
                            body: JSON.stringify(data)                           
                }) 
                .then(function(response) {
                    response.json().then(function(d){
                       
                       if(d == true) {
                            let postBox = document.getElementById(post_id);
                            postBox.parentNode.removeChild(postBox);
                       } else {
                           // show error modal
                       }

                       document.getElementById('deletebox').classList.add('lowlight');
                       lightboxshow(false);  
                       setScrollPos();
                       hideAllMenus();
                    })
                })
            }

            let deletePost = (el) => {

                const post_id = el.parentElement.getAttribute('post_id');
                const user_id = getCookie('userID');
                const text = document.getElementById('edit-comment').value;
                const data = {};

                data.post_id = post_id;
                data.text = text;
                data.user_id = user_id;
                document.documentElement.classList.add('lb');                  
                setPostVisibility(-1, el, user_id);
            }               
               

           
            let savePost = (el) => {
                const post_id = el.parentElement.getAttribute('data-post_id');
                const user_id = getCookie('userID');
                const text = document.getElementById('edit-comment').value;             
                const post = document.getElementById(post_id);              
                const postText = post.querySelectorAll('.content-wrap .text')[0];              
                const data = {};

                data.post_id = post_id;
                data.text = text;
                data.user_id = user_id;
                document.documentElement.classList.add('lb');

                return fetch('Triplesss/api/post_edit.php', {
                            method: "POST",
                            body: JSON.stringify(data)                           
                }) 
                .then(function(response) {
                    response.json().then(function(d){
                        //var postId = d.postId;                          
                        if(d.text) {
                            postText.innerHTML = d.text;                           
                        }
                       
                        document.getElementById('editbox').classList.add('lowlight');
                        lightboxshow(false);  
                        setScrollPos();             
                        hideAllMenus();
                    })
                })
            }

            let postMenu2 = () => {
                let div = newDiv('optionmenu');
                let options = ['Edit', 'Tag', 'Delete'];
                let icons = ['&#9998;', '#', '&#10006;'];
                options.map((op, i)=> {
                    let span = document.createElement('span');
                    span.className = op.toLocaleLowerCase();
                    span.innerHTML = icons[i];
                    span.setAttribute('data-action', op);
                    div.append(span);
                })
                return div;    
            }
                                

            let postAction = (action, el) => {                
                                          
                if(action == 'Tag' || action == 'Delete' || action == 'Edit' || 'Privacy') {
                    const boxname = action.toLowerCase() + "box";
                    const box = document.getElementById(boxname);
                    //const post_id = el.parentElement.getAttribute('data-post_id');
                    const post_id = el.parentElement.id;

                    box.classList.remove('lowlight');   
                    box.setAttribute('data-post_id', post_id);
                    document.documentElement.classList.add('lb');
                                                             
                    lightboxshow(true);  
                   
                    if(action == 'Edit') {
                        if(el.parentElement.querySelectorAll('.content-wrap .postcontent.text')) {
                            const text =  el.parentElement.querySelectorAll('.content-wrap .postcontent.text')[0].innerText;
                            box.querySelectorAll('textarea')[0].value = text; 
                        }                      
                    }    

                    if(action == 'Tag') {
                        getTags(el);
                    }                
                   
                }
            }             

            let hideAllMenus = () => {
                const menus = document.querySelectorAll('.post .options');
                menus.forEach((menu) => {
                    menu.classList.remove('swoopInRight');
                    menu.classList.add('hide');
                });                                    
            }

            let menuHandler = () => {
                var posts =  document.querySelectorAll('.postcontent');               

                posts.forEach(function(el) {
                    var hammertime = new Hammer(el);
                    var wrapper =  el.parentElement.parentElement;                      

                    /*
                    hammertime.on('tap', function(ev) {
                        if(ev.tapCount == 2) {                       
                                                                                               
                            wrapper.querySelectorAll('.options')[0].classList.remove('hide');
                            menushow(wrapper, true);                                                                            
                        }

                        if(ev.tapCount == 1) {                                                       
                           
                            if(!wrapper.querySelectorAll('.options')[0].classList.contains('hide')) {
                                lightboxshow(false);
                                menushow(wrapper, false);                                  
                                // hide any open boxes
                            }                                
                        } 
                      
                    });
                    */    
                });

                //const postoptions =  document.querySelectorAll('.post .options span');   
                const postoptions =  document.querySelectorAll('.post .optionmenu span');   

                postoptions.forEach(function(el) {
                    var hammertime = new Hammer(el);
                    hammertime.on('tap', function(ev) {
                      
                        var wrapper =  el.parentElement;                     
                        var data = ev.target.dataset;
                        wrapper.classList.remove('show'); 
                        postAction(data.action, wrapper);                     
                       
                    });
                }); 
            }
            
            /*
            let isloggedin = () => { 
               
               var uname = document.getElementById('uname');
               var userid = document.getElementById('userid');
              
               fetch('Triplesss/api/logged_in.php', {
                           method: "GET"                                                   
                   }
               ).then(function(response) {                  
                   
                   
                   response.json().then(function(d){
                          
                       //console.log(d);
                       if(d === true) {
                           //showBox(true, 'profile');
                           showBox(false, 'keycheck');
                           showBox(false, 'fail');
                           showBox(true, 'addpost');
                           uname.innerText = getCookie('userName'); 
                           userid.value = getCookie('userID'); 
                           document.getElementById('log-out').classList.remove('hidden');
                           getProfile();
                           feedlist();                            

                       }  else {
                           //showBox(false, 'profile');
                           showBox(true, 'keycheck');
                           showBox(false, 'fail');
                           document.getElementById('log-out').classList.add('hidden');
                       }
                   });                    

               })
           };
           */

           let getProfile = () => {
                var user_id = getCookie('userID'); 
                let url = 'Triplesss/api/profile.php?userid=' + user_id;

                fetch(url, {
                       method: "GET",                                           
                   }) 
                   .then(function(response) {
                       response.json().then(function(d){                                                   
                          
                            //console.log(d);
                            d.map(function(el) {
                                const profileImage = document.querySelectorAll('#avatar img')[0];
                                //const profileText = document.querySelectorAll('.bio-text')[0];
                                if(el) {
                                    if(el.content_type == 'image') {
                                        const src = el.path + '/' + el.link;
                                        profileImage.src = src;
                                    }                                   
                                }                              
                           })                          
                          
                       })
                   }
               )
            }
            
            
            window.onload = () => {
                let postButton = document.getElementById("post-comment");
                const feedId = document.getElementById('feed_id');
                const loginButton = document.getElementById("log-in"); 
                const logoutButton = document.getElementById("log-out");                
                const username = document.getElementById("username");
                const password = document.getElementById("password");
                const cancelButton = document.querySelectorAll('.cancel');
                const savePostButton = document.getElementById('savepost');
                const deletePostButton = document.getElementById('delete-yes');
                const tagPostButton = document.getElementById('tagpost');
                let reactButtons = document.querySelectorAll('.post-button');
                const commentPostButton = document.getElementById('comment-post');    
                


                lightbox = document.getElementById("lbox");
                lowlightelements(true, document.querySelectorAll('.tabgox'));            
               
                showBox(false, 'keycheck');
                showBox(false, 'fail');  
                showBox(true, 'addpost');   
                showBox(false, 'profile');                    
               
                isloggedin();      

                              
                loginButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    dologin();                    
                })

                logoutButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    dologout();                    
                })
                
                postButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    addPost();
                })                              
                
                cancelButton.forEach((button) => {
                    button.addEventListener('click', function(e) {
                       
                        lightboxshow(false);
                        setScrollPos();
                        hideAllMenus();
                        this.parentElement.classList.add('lowlight');
                    })
                })

                savePostButton.addEventListener('click', function(e) {
                    e.preventDefault(); 
                    setScrollPos(); 
                    savePost(this);                  
                })  

                deletePostButton.addEventListener('click', function(e) {
                    e.preventDefault(); 
                    setScrollPos(); 
                    deletePost(this);                  
                })  

                commentPostButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    postComment(e);
                })  


                tagPostButton.addEventListener('click', function(e) {
                    e.preventDefault(); 
                    setScrollPos(); 
                    editTags(this);                  
                })  


                feed_id.addEventListener('change', function(e) {
                    let fid = this.value;                  
                    setCookie('feed_id', fid, 1); 
                   feed(fid);
                });
                                             
                
                reactButtons.forEach(function(el) {
                    el.addEventListener('click', function(e) {
                        //console.log("like");
                        console.log(el);
                        var icon = el.querySelector('i');

                        if(el.classList.contains('like')) {
                            icon.classList.add('like-button-click');
                            window.setTimeout(function(){
                                icon.classList.remove('like-button-click');
                                var likecount = el.parentElement.querySelector('.post-likes');
                                var likes = likecount.innerHTML;
                                likes++;
                                likecount.innerHTML = likes;
                            }, 1000)
                        }

                        if(el.classList.contains('comment')) { 

                        }                                              
                       
                    });
                });               
                             

                var postoptions =  document.querySelectorAll('.post .options span');     

                postoptions.forEach(function(el) {
                    var hammertime = new Hammer(el);
                    hammertime.on('tap', function(ev) {
                        var wrapper =  el.parentElement;                     
                        var data = ev.target.dataset;
                        wrapper.classList.remove('show'); 
                        postAction(data.action, wrapper);                     
                       
                    });
                });            
                           
                             
                
            }

        </script>
    </body>
</html>




