<html>

    <head>

        <title>Password reset</title>

        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link href="https//fonts.googleapis.com/css2?family=Raleway&display=swap rel="stylesheet">

        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <link href="css/vivify.min.css" rel="stylesheet" type="text/css">

        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>      

        <link href="/css/main.css" rel="stylesheet" type="text/css">

        <style>

            #reset-link a{

                color: #666;

            }



            #resetbox, #passwordsentbox {

                top:100px;

            }

        </style>

    </head>

    <body>

        <div class="toprow">             
            <div class="clear"></div>           
        </div>    
       
        <div class="wrap">

            <div id="keycheck" class="add">

                <h3 id="login-heading">Message</h3>

                <form id="add-user" method="POST">                  

                    <span id="login-prompt"><p>You can now log in: </p></span>

                    <label>user name</label>

                    <input type="text" id="username" name="username" value="">

                    <label>password ( <span id="show-password">tap here</span> to show/hide )</label>

                    <input type="password" id="password" name="password" value="">

                    <br />

                    <br />

                    <button id="log-in">Log in</button>           

                </form>               

            </div>           



            <div id="details" class="details hidden">

                <h3>Enter your new password</h3>

                <form id="add-detail" method="POST">                    

                    <p>( min length 8 characters, at least one uppercase letter, a character, and a number e.g. bLUe234! )</p>

                    <input type="password" id="password1" name="password1" value="" placeholder="password"><br />

                    <br />                   

                    <input type="password" id="password2" name="password2" value="" placeholder="password (again)"><br />                 

                    <br />

                   <button id="password-update">Update password</button>&nbsp;<button id="show-login">Back to log in</button>                   

                </form>

            </div>

            <div id="invalid" class="add hidden">

                <h3>Error: Invalid link</h3>

                <p>The system could not find a matching user / key to complete your password reset request.</p>

                <p>Please make sure that you clicked or tapped on the reset link in THE LAST email we sent you. 

                    The links expire, and only the last one will let you reset your password!</p>

                <p>You can also try and send the <span id="resetlink"><a href="#">reset password</a></span> link again.</p>  

                <p>&nbsp;</p>  

                <p>&nbsp;</p>  

                <p>&nbsp;</p>  

                <p>&nbsp;</p>  

            </div>

            <div id="resetbox" class="vivify postbox lowlight">

                <h4>Lost password</h4>

                <p>If you have forgotten or lost your password, we can send you an email with a reset link.</p>

                <p>Just click the button below</p>                             

                <button id="reset-password">Reset my password</button>

                <button class="cancel">&#10005;</button>

            </div>  

            <div id="passwordsentbox" class="vivify postbox lowlight">

                <h4>Request sent</h4>

                <p>We just sent a password reset link to <span id="reset-email"></span>. Please check your email, 

                and once you get the message, just click or tap on the link.</p>

                <button id="close-reset">Close this message</button>

            </div>

           

            <div id="lbox" class="lightbox"></div>           

        </div>       



        <script src="/js/main.js"></script>

        <script language="Javascript">

            

            let lightbox;



                          

            window.onload = () => {                

           

                const loginButton = document.getElementById("log-in");   

                const showLoginButton = document.getElementById("show-login");   

                const resetLink = document.querySelectorAll('#resetlink a')[0];

                const resetPasswordButton = document.getElementById("reset-password");

                const closeResetButton = document.getElementById('close-reset');

                const resetSentBox = document.getElementById('passwordsentbox');

                const resetBox = document.getElementById('resetbox'); 

                const cancelButton = document.querySelectorAll('.cancel'); 

                const loginMessage =  document.getElementById('login-heading');                  

                const passwordUpdateButton = document.getElementById("password-update");

                const showPasswordLink = document.getElementById('show-password');   

                const urlParams = new URLSearchParams( window.location.search);

                const token = urlParams.getAll('key');

                const user_id = urlParams.getAll('user_id');



                lightbox = document.getElementById("lbox");



                addHandler(loginButton, 'click', function(e, el){

                    dologin('/');                    

                });



                addHandler(showLoginButton, 'click', function(e, el){

                    showBox(true, 'keycheck');   

                    showBox(false, 'details');                  

                });



                cancelButton.forEach((button) => {

                    addHandler(button, 'click', function(e, el) {

                        lightboxshow(false);

                        setScrollPos();

                        hideAllMenus();

                        el.parentElement.classList.add('lowlight');

                    });

                });



                addHandler(closeResetButton, 'click', function(e, el){

                    resetSentBox.classList.add('lowlight');

                    showBox(true, 'keycheck');

                    showBox(false, 'invalid');

                    lightboxshow(false);

                });



                



                addHandler(passwordUpdateButton, 'click', function(e, el){ 

                    const password1 = document.getElementById('password1');

                    const password2 = document.getElementById('password2');

                    const username = document.getElementById('username');

                    let userName = getCookie('userName');

                    if(typeof userName == 'undefined') {userName = ''}



                    password1.classList.remove('field_error');

                    password2.classList.remove('field_error');

                    const pwd = password1.value;

                                       

                    if(checkPassword(password1)){

                        if(checkPassword(password2)){

                            if(password1.value != password1.value) {

                                password2.classList.add('field_error');

                            } else {

                               

                               fetch('Triplesss/api/reset_password?userid=' + user_id + '&key=' + token + '&password=' + pwd, {

                                    method: "GET"                                                            

                                }).then(function(response) {

                                    response.json().then(function(d){ 

                                        

                                        if(d.hasOwnProperty('success')) {

                                            if(d.success == true) {

                                                showBox(true, 'keycheck');

                                                username.value = userName;

                                                loginMessage.innerText = "Log in with your new password";

                                                showBox(false, 'details');

                                            }

                                        }

                                    });

                                });

                            }



                        } else {

                            password2.classList.add('field_error');

                        }

                    } else {

                        password1.classList.add('field_error');

                    }                

                });



                resetPasswordButton.addEventListener('click', function(e) {

                    e.preventDefault();

                   

                    const sentBox = document.getElementById('passwordsentbox');

                    //const resetBox = document.getElementById('resetbox');

                    let data = {};

                    data.user_id = user_id;

                    data.user_name = '';

                    data.from = 'admin@surfsouthoz.com';

                    

                    fetch('Triplesss/api/reset_link?username=' + data.user_name + '&userid=' + data.user_id + '&from=' + data.from, {

                        method: "GET"

                                                

                    }).then(function(response) {

                        response.json().then(function(d){

                            console.log(d);

                            if(d.hasOwnProperty('link')) {

                                if(d.link.sent === true) {

                                    console.log(d.link);

                                    const sent_to = d.link.email;

                                    const resetEmail = document.getElementById('reset-email');

                                    resetEmail.innerText = sent_to;

                                    resetBox.classList.add('lowlight');

                                    sentBox.classList.remove('lowlight');



                                } else {

                                    alert("Error: could not send reset message!");

                                }

                                

                            } else {

                                alert("Error: could not send reset message.");

                            }

                            //showBox(true, 'keycheck');

                        });

                    });

                });  



                showPasswordLink.addEventListener('click', function(e) {

                    

                    if(password.classList.contains('pwshown')) {

                        password.setAttribute('type', 'password');

                        password.classList.add('fadeOut');

                        password.classList.remove('fadeIn');

                        password.classList.remove('pwshown');

                    } else {

                        password.setAttribute('type', 'text');

                        password.classList.add('fadeIn');

                        password.classList.remove('fadeOut');

                        password.classList.add('pwshown');

                    }                  

                })

              



                         

                fetch('Triplesss/api/reset_token?userid=' + user_id + '&token=' + token, {

                    method: "GET"                                            

                }).then(function(response) {

                    response.json().then(function(d){

                        

                        if(d) {

                            if(d.hasOwnProperty('valid')) {

                              

                                if(d.valid === true) {

                                    showBox(true, 'details');

                                    showBox(false, 'keycheck');

                                } else {

                                    showBox(false, 'details');

                                    showBox(false, 'keycheck');

                                    showBox(true, 'invalid');

                                }



                            }

                        }

                    })

                });

                





                resetLink.addEventListener('click', function() {

                 

                    const resetBox = document.getElementById('resetbox'); 

                    resetBox.classList.remove('lowlight')

                    lightboxshow(true);

                   

                    

                }) 

                

            }  

           



        </script>

    </body>

</html>









