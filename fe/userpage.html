<html>
    <head>
        <title>User post test</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https//fonts.googleapis.com/css2?family=Raleway&display=swap rel="stylesheet">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link href="../css/vivify.min.css" rel="stylesheet" type="text/css">
        <link href="../css/user.css" rel="stylesheet" type="text/css">
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>       
        <style>
            .wrap.loggedout {
                height:100%;
            }

            #profile {
                background-color: #fff;        
            }

            #profile .avatar img {
                width:80px;
                height:80px;
            }

            #profile .avatar {
                border-radius: 50px;
                width: 80px;
                height: 80px;
                overflow: hidden;
                border: 2px solid #33a9ee;
            }

            #profile h3 {
                margin: 0;
                padding: 0;
                margin-left: 95px;
                margin-top: -80px;
                float: left;
                font-size: 22px;
            }

            #profile .bio {
                float: left;
                margin-left: 95px;
                margin-top: -50px;
                font-size: 14px;
            }

            #nouser {
                background: #fff;
            }


            .reactions {
                margin-right:5px;
                margin-top:-35px;
            }    
           

            .post button i {
                color:#000;
            }
           

            #reportbox input {
                width:30px;
            }
        </style>
    </head>
    <body>
        <!-- <h2>User feed test</h2> -->
        <div class="toprow">
            <div id="head-wave"><img src="../img/head_wave.svg" /></div>
            <h3>               
                <span id="avatar">
                    <img src="../img/profile.png" />
                </span>
                <span id="uname"></span></h3>
            <button id="log-out">log out</button>
            <div class="clear"></div>
        </div>    
        </select>
        <div class="wrap">
            <div id="profile" class="add">
                <div class="avatar">
                    <img src="../img/profile.png" />
                </div>
                <h3></h3>
                <div class="bio"></div>
            </div>  
            <div id="nouser" class="add">
                <h4>Oh no!</h4>
                <p>No user with that name could be found. This might be because the link is incorrect.</p>
                <p>User names are cAsE Sensitive, so maybe you could check that?</p>
                <p>It's also possible this user no longer exists. How very sad that would be. :(</p>
                <p>&nbsp;</p>
                <p>&nbsp;</p>
                <p>&nbsp;</p>
                <p>&nbsp;</p>
                <p>&nbsp;</p>
            </div>   
            <div id="addpost" class="add">
                <label>Select a channel</label>
                <select id="feed_id"></select>
                <p>Post something</p>
                <form id="add-post" method="POST">
                   <textarea id="add-comment" rows="3" cols="36"></textarea><br /><br />
                   <input type="hidden" id="userid" name="userid" value="2">
                   <input type="hidden" id="feedid" name="feedid" value="<?php //echo $feed->getId();  ?>">
                   <input id="image" name="image" type="file" accept="image/x-png,image/gif,image/jpeg" />
                   <button id="post-comment">Post</button>
                </form>
            </div>
            <div id="keycheck" class="add">
                <h3>Login</h3>
                <form id="add-user" method="POST">                  
                    <label>user name</label>
                    <input type="text" id="username" name="username" value="">
                    <label>password</label>
                    <input type="password" id="password" name="password" value="">
                    <br />
                    <br />
                   <button id="log-in">Log in</button>                                
                </form>               
            </div> 
            <div id="fail" class="add">
                <h3>Login failed</h3>  
                <p>Please check you have the correct details! </p>               
            </div>
            <div id="editbox" class="vivify postbox lowlight">
                <p>Edit post</p>
                <textarea id="edit-comment" rows="3" cols="36"></textarea><br /><br />               
                <button id="savepost">Save</button>
                <button class="cancel">Cancel</button>
            </div>  
            <div id="tagbox" class="vivify postbox lowlight">
                <p>Add or edit tags</p>
                <input type="text" /><br /><br />      
                <button id="tagpost">Save</button>
                <button class="cancel">Cancel</button>
            </div>
            <div id="deletebox" class="vivify postbox lowlight">
                <p>Delete this post?</p>
                <button id="delete-yes">Yes, delete it</button>&nbsp;  <button class="cancel">No! keep it</button> 
            </div>  
            <div id="privacybox" class="vivify postbox lowlight">
                <p>Adjust who can see this post</p>
                <select id="visibility">
                    <option value=0>Me</options>
                    <option value=1>Group</options>
                    <option value=2>Friends</options>
                    <option value=3>Friends of friends</options>
                    <option value=4>Anyone</options>
                </select>
                <button id="privacypost">Save</button>
                <button class="cancel">Cancel</button>
            </div>  
            <div id="commentbox" class="vivify postbox lowlight">
                <p>Add a comment</p>
                <textarea id="post-comment-text" rows="5" cols="36"></textarea><br />  
                <button id="comment-post">Post</button>
                <button class="cancel">&#10005;</button>
                <div id="comments"></div>
            </div> 
            <div id="hidebox" class="vivify postbox lowlight">
                <p>Hide this post from your feed ( it will come back when you reload the page )?</p>
                <button id="hide-post">Yep!</button>
            </div>   
            <div id="feed" class="feed">
            </div>
            <div id="lbox" class="lightbox"></div>           
        </div>

        <script src="/js/user.js"></script>

        <script language="Javascript">

            var lightbox;
            let toppos = 0;
          

            let getUserId = () => {
                return fetch('../Triplesss/api/userid.php', {
                            method: "GET"                                                    
                })                    
            }        


            let postMarkup = (post, container) => {               
                
                post.map(function(p) {
                    //console.log(p);
                    if(p[0]) {
                        const postId = p[0].post_id;
                        let postWrap = newDiv('post');
                        let contentWrap = newDiv('content-wrap');
                        postWrap.id = postId;
                        //postWrap.setAttribute('data-post_id', postId);
                        
                        let contentWrapImage = newDiv('postcontent image');
                        let contentWrapText = newDiv('postcontent text');
                        
                        //postWrap.appendChild(postMenu());                    
                        postWrap.appendChild(postMenu3()); 
                        postWrap.appendChild(reactions(p));                         


                        p.map(function(po) {                      
                            if(po.content_type == "text") {
                                contentWrapText.innerText = po.content;
                                contentWrap.appendChild(contentWrapText);
                            }
                            if(po.content_type == "image") {
                                const img =  document.createElement('img');
                                img.src = po.path + "/" + po.link;
                                contentWrapImage.appendChild(img);
                                contentWrap.appendChild(contentWrapImage);
                            }
                        })

                        postWrap.appendChild(contentWrap);                          
                        container.appendChild(postWrap);
                    }                   
                }); 
                getReactions();               
                   
            }
            

            let clearPostBox = () => {                
                document.getElementById('add-comment').value = '';
                document.getElementById('image').value = '';
            }

            let setSelect = (selectObj, index) => {
                Array.from(selectObj.options).forEach((op, i)=>{
                    console.log(i);
                });               
            }            


            let feed = (feed_id) => {
                let container = document.querySelectorAll('.feed')[0];
                container.innerHTML = '';
                return fetch('/Triplesss/api/feed.php?feed_id=' + feed_id, {
                            method: "GET"                                                    
                }) 
                .then(function(response) {
                    response.json().then(function(d){
                        postMarkup(d, container);  
                        menuHandler();                     
                    });
                });       
            }

            let feedlist = () => {
                const userid = getCookie('userID');
                const saved_feedid = getCookie('feed_id');
                const feedSelect = document.getElementById('feed_id');
                fetch('/Triplesss/api/feeds.php?userid=' + userid, {
                    method: "GET"                                                    
                }) 
                .then(function(response) {
                    response.json().then(function(d){
                        const feed_id = d[0].id;
                        if(saved_feedid) {
                            //feed(saved_feedid);
                        } else {
                            //feed(feed_id);
                        }
                       
                        if(d.length > 0) {
                            d.map(function(r){
                                const option = document.createElement('option');
                                option.text = r.feed_name;
                                option.value = r.id;
                                feedSelect.add(option);
                                if(saved_feedid == r.id) {
                                    option.selected = true; 
                                }
                            })
                        } else {
                            // Every user has at least ONE feed so this should neve rhappen
                        }
                    })
                })
            }

            /*

            let getComments = (post_id) => {
                       
                return fetch('/Triplesss/api/comments.php?post_id=' + post_id, {
                    method: "GET"                                                  
                }) 
                .then(function(response) {
                    response.json().then(function(d){
                        const comments = d.comments;
                        const comments_box = document.getElementById('comments');
                        comments_box.innerHTML = '';
                       
                        comments.map(function(comment) {
                            
                            const wrap = document.createElement('div');
                            wrap.className = 'comment_wrap';
                            const username = comment.user_name;
                            const text = comment.content; 
                            const uspan = document.createElement('span');
                            uspan.className = "comment_user";
                            const ulink = document.createElement('a');
                            ulink.innerText = username;
                            ulink.href = '/userpage/' + username;
                            uspan.append(ulink);
                           
                            const cspan = document.createElement('span');
                            cspan.className = "comment_text";
                            cspan.innerText = text;
                            wrap.append(uspan);
                            wrap.append(cspan);
                            comments_box.append(wrap);                                           
                        });
                    });
                });
            }

            */

          
            let sendReport = (e) => {
               
                let groupId = e.parentElement.className.replace("reportbox vivify ", "");
                let postId = e.parentElement.getAttribute('data-post_id');
                let post = document.getElementById(postId);
                let postButton = post.getElementsByClassName('report')[0];

                //console.log(groupId);

                e.parentElement.classList.add('fadeOut');
                window.setTimeout(function(){
                    e.parentElement.classList.add('lowlight');
                    lightboxshow(false);
                    var wrapper = document.getElementsByClassName('post ' + groupId)[0];                    
                    postButton.classList.add('red');
                    e.parentElement.classList.remove('fadeOut');
                }, 300)
            }

            /*
            let postComment = () => {
                const comment = document.getElementById('post-comment-text').value;
                const user_id = getCookie('userID');
                const post_id = document.getElementById('commentbox').getAttribute('data-post_id');
                const feed_id = document.getElementById('feed_id');
                const post = document.getElementById(post_id);      
                const post_comments = post.querySelectorAll('.reactions .post-comments')[0];               
                let post_count = post_comments.innerText;
                

                const data = {};
                data.comment = comment;
                data.userid = user_id;
                data.postid = post_id;
                data.feedid = feed_id;                
                
                return fetch('/Triplesss/api/comment.php', {
                    method: "POST",
                    body: JSON.stringify(data)                           
                }) 
                .then(function(response) {
                    response.json().then(function(d){
                        document.getElementById('post-comment-text').value = '';
                        getComments(post_id);
                        post_count++;
                        post_comments.innerText = post_count;         
                    });
                });
            }
            */

   
            let doPost = (data) => {
                return fetch('/Triplesss/api/post.php', {
                            method: "POST",
                            body: JSON.stringify(data)                           
                }) 
                .then(function(response) {
                    response.json().then(function(d){
                        var postId = d.postId; 
                        clearPostBox();  
                        //console.log(postId);
                    })
                })
            }

                        
            let addPost = () => {
                let img = document.getElementById('image').files[0];
                const user_id = document.getElementById('userid').value;
                const feed_id = document.getElementById('feed_id').value;
                const comment = document.getElementById('add-comment').value;
                let data = {'comment': comment, 'userid': user_id, 'feedid': feed_id, 'basefolder' : '../../storage' };
            
                // Check if there's an image
                var reader = new FileReader();

                reader.onload = (function(t) {
                    return function(e) {
                        data.image = e.target.result;                       
                        doPost(data).then(function(){
                            feed(feed_id);
                        });                  
                    }
                })(img); 
            
                //reader.readAsDataURL(img);
                if(typeof img === 'object') {
                    reader.readAsDataURL(img);
                } else { 
                    // we don't have an image... just text
                   data.image = '';
                    doPost(data).then(function(){
                        feed(feed_id);
                    });    
                }
            } 

            let getTags = (el) => { 
                const data = {};
                const post_id =  el.parentElement.id;    
                const user_id = getCookie('userID');                                        
                data.post_id = post_id; 
                data.user_id = user_id;

                return fetch('/Triplesss/api/post_tags.php?user_id=' + user_id + '&post_id=' + post_id, {
                    method: "GET"                                                 
                }) 
                .then(function(response) {                   
                    
                    response.json().then(function(d){
                       // show tags in the textbox   
                       let tags = "";
                       if(d.tags) {
                            if(d.tags.length > 0) {
                                const tag_array = d.tags.split(',');
                                tags = tag_array.map((tag)=>{
                                    return "#" + tag;
                                }).join(' ');
                            }                            
                        }                       
                       document.querySelectorAll('#tagbox input')[0].value = tags;                    
                    })                    
                })
            }


            let editTags = (el) => {
                const data = {};
                const post_id =  el.parentElement.getAttribute('data-post_id');    
                const user_id = getCookie('userID');  
                const tags = document.querySelectorAll('#tagbox input')[0].value;               
                data.post_id = post_id; 
                data.user_id = user_id;
                data.tags = tags;

                return fetch('/Triplesss/api/post_tags.php', {
                            method: "POST",
                            body: JSON.stringify(data)                           
                }) 
                .then(function(response) {
                    response.json().then(function(d){
                       
                       if(d == true) {
                            // tags added
                       } else {
                           // show error modal
                       }

                       document.getElementById('tagbox').classList.add('lowlight');
                       lightboxshow(false);  
                       setScrollPos();
                       hideAllMenus();
                    })
                })
            }


            let setPostVisibility = (level, el, user_id) => {
                const data = {};
                const post_id =  el.parentElement.getAttribute('data-post_id');
                data.level = level;                              
                data.post_id = post_id; 
                data.user_id = user_id;

                return fetch('/Triplesss/api/post_visibility.php', {
                            method: "POST",
                            body: JSON.stringify(data)                           
                }) 
                .then(function(response) {
                    response.json().then(function(d){
                       
                       if(d == true) {
                            let postBox = document.getElementById(post_id);
                            postBox.parentNode.removeChild(postBox);
                       } else {
                           // show error modal
                       }

                       document.getElementById('deletebox').classList.add('lowlight');
                       lightboxshow(false);  
                       setScrollPos();
                       hideAllMenus();
                    })
                })
            }

            let deletePost = (el) => {

                const post_id = el.parentElement.getAttribute('post_id');
                const user_id = getCookie('userID');
                const text = document.getElementById('edit-comment').value;
                const data = {};

                data.post_id = post_id;
                data.text = text;
                data.user_id = user_id;
                document.documentElement.classList.add('lb');                  
                setPostVisibility(-1, el, user_id);
            }

            /*
            let lowlightelements = (s, el) => {
                //var posts =  document.querySelectorAll('.post');                
                el.forEach(function(el) { 
                    if(s === true) {
                        el.classList.add('lowlight');
                    } else {
                        el.classList.remove('lowlight');
                    }    
                });   
            }
            */

            
            /*
            let lightboxshow = (s) => {
                //document.querySelector('body').scrollTop = top;  
                //scrollPos(toppos);   
                if(s === true) {
                    lightbox.classList.add('active');  
                    getScrollPos(); 
                                                  
                } else {
                    
                    lightbox.classList.remove('active');  
                                      
                    window.setTimeout(function() {                        
                        document.documentElement.classList.remove('lb');                      
                    }, 100)                           
                }
                lowlightelements(s, document.querySelectorAll('.post'));
                           
            }  
            */
            
            let menushow = (wrapper, s) => {
                if(s === true) {
                    wrapper.querySelectorAll('.options')[0].classList.remove('hide');
                    wrapper.querySelectorAll('.options')[0].classList.add('swoopInRight'); 
                    wrapper.querySelectorAll('.options')[0].classList.remove('swoopOutRight'); 
                } else {
                    wrapper.querySelectorAll('.options')[0].classList.add('swoopOutRight'); 
                    wrapper.querySelectorAll('.options')[0].classList.remove('swoopInRight');
                    window.setTimeout(function() {
                        wrapper.querySelectorAll('.options')[0].classList.add('hide');
                    }, 500);
                }                
            }

            /*
            let uniqid = (a = "", b = false) => {
                const c = Date.now()/1000;
                let d = c.toString(16).split(".").join("");
                while(d.length < 14) d += "0";
                let e = "";
                if(b){
                    e = ".";
                    e += Math.round(Math.random()*100000000);
                }
                return a + d + e;
            }
            */

            /*
            let getPostById = (post_id) => {
                var posts =  document.querySelectorAll('.post');   
                let post = false;            
                posts.forEach(function(el) {
                    if(el.getAttribute('post_id') == post_id) {
                        post = el;
                    }
                });   
                return post;
            }
            */

            let savePost = (el) => {
                const post_id = el.parentElement.getAttribute('data-post_id');
                const user_id = getCookie('userID');
                const text = document.getElementById('edit-comment').value;             
                const post = document.getElementById(post_id);              
                const postText = post.querySelectorAll('.content-wrap .text')[0];              
                const data = {};

                data.post_id = post_id;
                data.text = text;
                data.user_id = user_id;
                document.documentElement.classList.add('lb');

                return fetch('/Triplesss/api/post_edit.php', {
                            method: "POST",
                            body: JSON.stringify(data)                           
                }) 
                .then(function(response) {
                    response.json().then(function(d){
                        //var postId = d.postId;                          
                        if(d.text) {
                            postText.innerHTML = d.text;                           
                        }
                       
                        document.getElementById('editbox').classList.add('lowlight');
                        lightboxshow(false);  
                        setScrollPos();             
                        hideAllMenus();
                    })
                })
            }

            let postMenu3 = () => {
                let div = newDiv('optionmenu');
                return div;
            }    

            let postMenu2 = () => {
                let div = newDiv('optionmenu');
                let options = ['Edit', 'Tag', 'Delete'];
                let icons = ['&#9998;', '#', '&#10006;'];
                options.map((op, i)=> {
                    let span = document.createElement('span');
                    span.className = op.toLocaleLowerCase();
                    span.innerHTML = icons[i];
                    span.setAttribute('data-action', op);
                    div.append(span);
                })
                return div;    
            }

            /*

            let reactions = (p) => { 
                if(p) {

                    let comment_count = p[0]['comment_count']; 
                    let likes = p[0]['likes']; 
                    if(p[1]) {
                        comment_count = p[1]['comment_count'];
                        likes = p[1]['likes'];
                    }                    
                   
                    let div = newDiv('reactions');
                   
                    
                    let comment_button = document.createElement('button');
                    comment_button.className = "post-button comment";
                    let icon = document.createElement('i');
                    icon.className = "material-icons";
                    icon.innerText="comment";
                    comment_button.append(icon);
                    div.append(comment_button);
                    let comment_span = document.createElement('span');
                    comment_span.className = "post-comments";
                    if(comment_count > 0) {
                        comment_span.innerText = comment_count;
                    }
                    div.append(comment_span);
                    addReact(comment_button);              
                    

                    let like_button = document.createElement('button');
                    like_button.className = "post-button like";
                    icon = document.createElement('i');
                    icon.className = "material-icons";
                    icon.innerText="favorite";
                    like_button.append(icon);
                    div.append(like_button);
                    let like_span = document.createElement('span');
                    like_span.className = "post-likes";
                    if(likes > 0) {
                        like_span.innerText = likes;
                    }
                    div.append(like_span);
                    addReact(like_button);               
                    return div;
                }    
            }

            */
                               

            let postAction = (action, el) => {                
                                          
                if(action == 'Tag' || action == 'Delete' || action == 'Edit' || 'Privacy') {
                    const boxname = action.toLowerCase() + "box";
                    const box = document.getElementById(boxname);
                    //const post_id = el.parentElement.getAttribute('data-post_id');
                    const post_id = el.parentElement.id;

                    box.classList.remove('lowlight');   
                    box.setAttribute('data-post_id', post_id);
                    document.documentElement.classList.add('lb');
                                                             
                    lightboxshow(true);  
                   
                    if(action == 'Edit') {
                        if(el.parentElement.querySelectorAll('.content-wrap .postcontent.text')) {
                            const text =  el.parentElement.querySelectorAll('.content-wrap .postcontent.text')[0].innerText;
                            box.querySelectorAll('textarea')[0].value = text; 
                        }                      
                    }    

                    if(action == 'Tag') {
                        getTags(el);
                    }               
                }
            }  
            
            /*

            let dologout = () => { 
                fetch('/Triplesss/api/logout.php', {
                        method: "GET"                                                   
                    }
                ).then(function(response) {   
                    setCookie('feed_id', '', -1);
                    window.location.reload();
                })
            }

            let dologin = () => {
                let data = {};

                const username = document.getElementById('username');
                const password = document.getElementById('password');
                data.username = username.value;
                data.password = password.value;

                fetch('/Triplesss/api/login.php', {
                            method: "POST",
                            body: JSON.stringify(data)                           
                    }
                ).then(function(response) {                  
                    response.json().then(function(d){
                       
                        console.log(d);  
                        if(d.success == 'false') {
                            password.className = 'field_error';
                        } else if(d.success == 'true') {
                            password.className = '';
                            showBox(false, 'keycheck');
                            showBox(false, 'fail');
                            showBox(true, 'feed');
                            document.getElementById('uname').innerText = d.username;
                            getProfile(); 
                            window.location.reload();
                        }                                 
                    })
                });   
            };

            */

            let hideAllMenus = () => {
                const menus = document.querySelectorAll('.post .options');
                menus.forEach((menu) => {
                    menu.classList.remove('swoopInRight');
                    menu.classList.add('hide');
                });                                    
            }

            let menuHandler = () => {
                var posts =  document.querySelectorAll('.postcontent');               

                posts.forEach(function(el) {
                    var hammertime = new Hammer(el);
                    var wrapper =  el.parentElement.parentElement;                      

                    /*
                    hammertime.on('tap', function(ev) {
                        if(ev.tapCount == 2) {                       
                                                                                               
                            wrapper.querySelectorAll('.options')[0].classList.remove('hide');
                            menushow(wrapper, true);                                                                            
                        }

                        if(ev.tapCount == 1) {                                                       
                           
                            if(!wrapper.querySelectorAll('.options')[0].classList.contains('hide')) {
                                lightboxshow(false);
                                menushow(wrapper, false);                                  
                                // hide any open boxes
                            }                                
                        } 
                      
                    });
                    */    
                });

                //const postoptions =  document.querySelectorAll('.post .options span');   
                const postoptions =  document.querySelectorAll('.post .optionmenu span');   

                postoptions.forEach(function(el) {
                    var hammertime = new Hammer(el);
                    hammertime.on('tap', function(ev) {
                      
                        var wrapper =  el.parentElement;                     
                        var data = ev.target.dataset;
                        wrapper.classList.remove('show'); 
                        postAction(data.action, wrapper);                     
                       
                    });
                }); 
            }
            
            /*
            let isloggedin = () => { 
               
               var uname = document.getElementById('uname');
               var userid = document.getElementById('userid');
              
               fetch('/Triplesss/api/logged_in.php', {
                           method: "GET"                                                   
                   }
               ).then(function(response) {                  
                   
                   
                   response.json().then(function(d){
                          
                       //console.log(d);
                       if(d === true) {
                           //showBox(true, 'profile');
                           showBox(false, 'keycheck');
                           showBox(false, 'fail');
                           //showBox(true, 'addpost');
                           uname.innerText = getCookie('userName'); 
                           userid.value = getCookie('userID'); 
                           document.getElementById('log-out').classList.remove('hidden');
                           getProfile();
                           feedlist();                            

                       }  else {
                           //showBox(false, 'profile');
                           showBox(true, 'keycheck');
                           showBox(false, 'fail');
                           document.getElementById('log-out').classList.add('hidden');
                       }
                   });                    

               })
           };

           */

           let getProfile = () => {
                var user_id = getCookie('userID'); 
                let url = '/Triplesss/api/profile.php?userid=' + user_id;

                fetch(url, {
                       method: "GET",                                           
                   }) 
                   .then(function(response) {
                       response.json().then(function(d){                                                   
                          
                            //console.log(d);
                            d.map(function(el) {
                                const profileImage = document.querySelectorAll('#avatar img')[0];
                                //const profileText = document.querySelectorAll('.bio-text')[0];
                                if(el) {
                                    if(el.content_type == 'image') {
                                        const src = el.path + '/' + el.link;
                                        profileImage.src = src;
                                    }                                   
                                }                              
                           })                          
                          
                       })
                   }
               )
            }


            let feedProfile = (user_id) => {
               
               let url = '/Triplesss/api/profile.php?userid=' + user_id;

               fetch(url, { 
                   method: "GET"
               })
               .then(function(response) {
                   response.json().then(function(d){    
                       d.map(function(el) {
                           const profileImage = document.querySelectorAll('#profile .avatar img')[0];
                           const profileName = document.querySelectorAll('#profile h3')[0];
                           const profileText = document.querySelectorAll('#profile .bio')[0];
                           if(el.content_type == 'image') {
                               const src = el.path + '/' + el.link;
                               profileImage.src = src;
                               profileName.innerText = el.user_name;
                           } 

                           if(el.content_type == 'text') { 
                               profileText.innerText = el.content;
                           }  
                       })
                   });
               });
           };  
            
            
            window.onload = () => {
                let postButton = document.getElementById("post-comment");
                const feedId = document.getElementById('feed_id');
                const loginButton = document.getElementById("log-in"); 
                const logoutButton = document.getElementById("log-out");                
                const username = document.getElementById("username");
                const password = document.getElementById("password");
                const cancelButton = document.querySelectorAll('.cancel');
                const savePostButton = document.getElementById('savepost');
                const deletePostButton = document.getElementById('delete-yes');
                const tagPostButton = document.getElementById('tagpost');
                let reactButtons = document.querySelectorAll('.post-button');

                const commentPostButton = document.getElementById('comment-post');               
                const reportButton = document.querySelectorAll('.report');
                let postoptions =  document.querySelectorAll('.post .options span');                     


                lightbox = document.getElementById("lbox");
                lowlightelements(true, document.querySelectorAll('.tabgox'));            
               
                showBox(false, 'keycheck');
                showBox(false, 'fail');  
                showBox(false, 'addpost');   
                showBox(false, 'nouser');                
               
                isloggedin();    

                //getUserId(); // used the last part of the URL to work out whose profile page this is

                getUserId().then(

                    function(response) {
                        response.json().then(function(d) {
                            const userid = d.userid;

                            if(userid > 0) {
                                feedProfile(userid);
                                fetch('/Triplesss/api/feeds.php?userid=' + userid, {
                                    method: "GET"                                                    
                                }) 
                                .then(function(response) {
                                    response.json().then(function(d){
                                        const feed_id = d[0].id;
                                        feed(feed_id);
                                    });
                                })    
                            } else {
                                showBox(true, 'nouser');         
                            } 
                        });        
                    }                  
                );
                    
                   
                       

                loginButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    dologin();                    
                })

                logoutButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    dologout();                    
                })
                
                postButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    addPost();
                })  

                commentPostButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    postComment(e);
                })                               
                
                cancelButton.forEach((button) => {
                    button.addEventListener('click', function(e) {
                       
                        lightboxshow(false);
                        setScrollPos();
                        hideAllMenus();
                        this.parentElement.classList.add('lowlight');
                    })
                })

                savePostButton.addEventListener('click', function(e) {
                    e.preventDefault(); 
                    setScrollPos(); 
                    savePost(this);                  
                })  

                deletePostButton.addEventListener('click', function(e) {
                    e.preventDefault(); 
                    setScrollPos(); 
                    deletePost(this);                  
                })  


                tagPostButton.addEventListener('click', function(e) {
                    e.preventDefault(); 
                    setScrollPos(); 
                    editTags(this);                  
                })  


                feed_id.addEventListener('change', function(e) {
                    let fid = this.value;                  
                    setCookie('feed_id', fid, 1); 
                   //feed(fid);
                });
                                             
                
                reactButtons.forEach(function(el) {
                    el.addEventListener('click', function(e) {
                        //console.log("like");
                        console.log(el);
                        var icon = el.querySelector('i');

                        if(el.classList.contains('like')) {
                            icon.classList.add('like-button-click');
                            window.setTimeout(function(){
                                icon.classList.remove('like-button-click');
                                var likecount = el.parentElement.querySelector('.post-likes');
                                var likes = likecount.innerHTML;
                                likes++;
                                likecount.innerHTML = likes;
                            }, 1000)
                        }

                        if(el.classList.contains('comment')) { 

                        }                                              
                       
                    });
                });               
                         
                postoptions.forEach(function(el) {
                    var hammertime = new Hammer(el);
                    hammertime.on('tap', function(ev) {
                        var wrapper =  el.parentElement;                     
                        var data = ev.target.dataset;
                        wrapper.classList.remove('show'); 
                        postAction(data.action, wrapper);                     
                       
                    });
                });         
                                            
            }

        </script>
    </body>
</html>




